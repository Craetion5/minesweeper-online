<!DOCTYPE html>
<html>

<body>

  <h1>Online Minesweeper</h1>
  <p>Left click to reveal tile, right click to set flag.</p>

  <canvas id="myCanvas" oncontextmenu="return false" style="border:1px solid #000000;">
  </canvas>

  <p>Player count: <span id="playercount">?</span></p>
  <p>Flags placed: <span id="flagsplaced">?</span>/<span id="flagstotal">?</span></p>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    let socket = io();
    var playerCount = 0;
    var arr = [];
    var ctx;
    var canvas = null;
    function clicked(x, y) {
      socket.emit('clicked', { x, y });
    }
    socket.on('playercount updated', (newCount) => {
      playerCount = newCount;
      console.log({ playerCount });
      document.getElementById("playercount").textContent = playerCount;
    });
    socket.on('gamestate updated', (newState) => {
      console.log('Gamestate update received:')
      console.log({ newState })

      arr = newState;
      if (canvas === null) {
        initCanvas();
      }
      draw();
    });



    const img_unid = new Image(),
      img_flag = new Image(),
      img_mine = new Image(),
      img_0 = new Image(),
      img_1 = new Image(),
      img_2 = new Image(),
      img_3 = new Image(),
      img_4 = new Image(),
      img_5 = new Image(),
      img_6 = new Image(),
      img_7 = new Image(),
      img_8 = new Image();




      img_unid.src = 'assets/unrevealed.png';
      img_flag.src = 'assets/flag.png';
      img_mine.src = 'assets/mine_hit.png';
      img_0.src = 'assets/mine_0.png';
      img_1.src = 'assets/mine_1.png';
      img_2.src = 'assets/mine_2.png';
      img_3.src = 'assets/mine_3.png';
      img_4.src = 'assets/mine_4.png';
      img_5.src = 'assets/mine_5.png';
      img_6.src = 'assets/mine_6.png';
      img_7.src = 'assets/mine_7.png';
      img_8.src = 'assets/mine_8.png';
    


      

    function initCanvas() {
      canvas = document.getElementById('myCanvas'),
        canvasLeft = canvas.offsetLeft + canvas.clientLeft,
        canvasTop = canvas.offsetTop + canvas.clientTop;

      ctx = canvas.getContext('2d');
      ctx.canvas.width = arr.length * 21;
      ctx.canvas.height = arr[0].length * 21;


      canvas.addEventListener('click', function () {
        let x = Math.floor((event.pageX - canvasLeft) / 21);
        let y = Math.floor((event.pageY - canvasTop) / 21);
        console.log("left clicked at x: ", x, " y: ", y)

        clicked(x, y);

      }, false);

      canvas.addEventListener('contextmenu', function () {
        var x = event.pageX - canvasLeft,
          y = event.pageY - canvasTop;
        console.log("right clicked at (" + Math.floor(x / 21) + "," + Math.floor(y / 21) + ")")
      }, false);

    };
    function draw() {
      for (let i = 0; i < arr.length; i++) {
        for (let j = 0; j < arr[0].length; j++) {
          switch (arr[i][j]) {
            case 0:
              ctx.drawImage(img_0, i * 21, j * 21, 21, 21);
              break;
            case 1:
              ctx.drawImage(img_1, i * 21, j * 21, 21, 21);
              break;
            case 2:
              ctx.drawImage(img_2, i * 21, j * 21, 21, 21);
              break;
            case 3:
              ctx.drawImage(img_3, i * 21, j * 21, 21, 21);
              break;
            case 4:
              ctx.drawImage(img_4, i * 21, j * 21, 21, 21);
              break;
            case 5:
              ctx.drawImage(img_5, i * 21, j * 21, 21, 21);
              break;
            case 6:
              ctx.drawImage(img_6, i * 21, j * 21, 21, 21);
              break;
            case 7:
              ctx.drawImage(img_7, i * 21, j * 21, 21, 21);
              break;
            case 8:
              ctx.drawImage(img_8, i * 21, j * 21, 21, 21);
              break;
            case 9:
              ctx.drawImage(img_unid, i * 21, j * 21, 21, 21);
              break;
            case 10:
              ctx.drawImage(img_flag, i * 21, j * 21, 21, 21);
              break;
            case 11:
              ctx.drawImage(img_mine, i * 21, j * 21, 21, 21);
              break;
            default:
              break;
          }
          }
        }
      };

    window.addEventListener('load', (event) => {
      draw();
    })


  </script>

</body>

</html>